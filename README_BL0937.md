# Для устройств с датчиком BL0937:

## *Передача показаний:*

![sens_pl0937.gif](https://raw.githubusercontent.com/pvvx/TlsrSmartSwitch/refs/heads/master/img/sens_pl0937.gif)

* Значения “Current” и “Voltage” регистрируются поочередно с шагом в 1 секунду. По 4-ре раза для каждого значения за цикл измерения в 8 секунд.
* Значение “Power” регистрируются непрерывно с шагом 8 секунд с учетом “Power Factor” и имеет малое разрешение. “Summation delivered” набирается без потерь с максимальной точнотью.
* Все показания обрабатываются с шагом 8 секунд.
* “Power Factor” не передается чипом и в данной версии FW не вычисляется. 

### *Передача показаний в Zigbee осуществляется в формате:*

![grf_pl0937.gif](https://raw.githubusercontent.com/pvvx/TlsrSmartSwitch/refs/heads/master/img/grf_pl0937.gif)

* Current:  0.001 (A), минимальный шаг измерений:  1 mA
* Voltage: 0.01 (V), минимальный шаг измерений: 30 mV 
* Power:  3 Auto-mode: 0.1, 0.01 (W), минимум: 0.16 W
* Summation delivered: 0.00001 (kWh), накопление с шагом менее 0.01 Wh

Значение “Voltage” * “Current” может не совпадать со значением “Power”, так как “Power” выводится с учетом “Power Factor”.

“Summation delivered” имеет более точные показания энергии с учетом “Power Factor”.

## *Настройки для BL0937:*

### Cluster ***0x0B04***: _Electrical Measurement_:

* Attribute ***0x0514***: _rms_extreme_over_voltage_period_ - период перезапуска в секундах после отключения реле по срабатыванию граничных порогов. Шаг обработки 8 секунд. При значении равному нулю перезапуск отключен. Единица измерения 1 секунда. По умолчанию 0 секунд - отключен.
* Attribute ***0x0515***: _rms_extreme_under_voltage_period_ - период проверки порогов при включении питания до включения реле. Шаг обработки 8 секунд. При значении равному нулю отключено. Единица измерения 1 секунда. По умолчанию 0 секунд - отключено.
* Attribute ***0x0517***: _rms_voltage_swell_period_ – период превышения тока до отключения в секундах. Шаг 8 секунд. При значении равному нулю отключение по превышению току отключено. Единица измерения 1 секунда. По умолчанию 8 секунд.
* Attribute ***0x0807***: _rms_extreme_over_voltage_ – значение максимального напряжения,  единица измерения 0.01В. Значение по умолчанию равно 260.00V. При превышении указанного напряжения реле отключается. При значении равному нулю отключение по превышению напряжения не производится.
* Attribute ***0x0808***: _rms_extreme_under_voltage_ – значение минимального напряжения,  единица измерения 0.01В. Значение по умолчанию равно 180.00V. Реле отключается при напряжении ниже указанного. При значении равному нулю отключение по пониженному напряжению не производится.
* Attribute ***0x080a***: _rms_voltage_swell_ – значение максимального тока,  единица измерения 0.001A. Значение по умолчанию равно 25.000A. При превышении указанного тока реле отключается. При значении равному нулю отключение по превышению тока отключено. Интервал длительности превышения тока задается в rms_voltage_swell_period.

* Attribute ***0xF007***: Coefficient for calculating _current_ – значение коэффициента множителя для счетчика импульсов тока. По умолчанию равен 178060.
* Attribute ***0xF008***: Coefficient for calculating _voltage_ – значение коэффициента множителя для счетчика импульсов напряжения. По умолчанию равен 197732.
* Attribute ***0xF009***: Coefficient for calculating _power_ – значение коэффициента множителя для счетчика импульсов мощности. По умолчанию равен 1081452.


Примерное соотношение коэффициентов для расчета мощности и энергии после калибровки значений токов и напряжения с резистивной нагрузкой (PF = 1.0):

Kpower = (Kcurrent x  Kvoltage) / 32768

Kenergy = Kpower x 3600 / 8

Точность соотношений зависит от разбросов в попавшемся чипе BL0942, коэффициента мощности (PF) нагрузки и номиналов элементов делителей.

Для всех переменных отсчета интервалов следует учитывать интервал измерения BL0937 в 8 секунд!

При установке интервала некратного 8-ми секундам, отработка произойдет при счете следующей кратной 8-ми секунде.


## *Калибровка BL0937:*

* Attribute ***0xF080***: _calibration_current_ – значение тока в мА для калибровки. Пример: 3.541А -> 3541
* Attribute ***0xF081***: _calibration_voltage_ – значение напряжения в десятках мВ для калибровки. Пример: 230.21В -> 23021
* Attribute ***0xF082***: _calibration_power_ – значение мошности в сотых Вт для калибровки. Пример: 1800.5Вт -> 18005

При задании _calibration_power_  равного  “1” производится пересчет коэффициентов для расчета мощности и энергии, исходя из замеров напряжения и тока.

После ввода любого значения или нескольких калибровочных значений начинается отсчет 4-х циклов измерения BL0937 для накопления средних значений. 
Через 4-ре цикла измерений производится перерасчет выбранных типов коэффициентов для преобразования полученных от BL0937 значений в соответствующие единицы измерения.

(!) 4-ре цикла измерения BL0937 равны 32-м секундам. Плюс до 8-ми секунд для ожидания старта нового цикла BL0937.